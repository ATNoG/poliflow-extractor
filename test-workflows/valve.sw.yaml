# Real estate listing website example from Valve: Securing Function Workflows on Serverless Computing Platforms

id: valve
name: Valve real estate listing website example
version: '0.1.0'
specVersion: '0.8'
description: Real estate listing website
start: entry-event

events:
  - name: triggerEvent
    type: http.request.received
    source: http-event-sources
    kind: consumed
  - name: uploadPhoto
    type: photo.database.upload
    kind: produced
  - name: newPhoto
    type: photo.database.new
    source: photo-db-source
    kind: consumed
  - name: uploadInfo
    type: info.database.upload
    kind: produced
  - name: newInfo
    type: info.database.new
    source: info-db-source
    kind: consumed

functions:
  - name: f1
    type: custom
    operation: knative:services.v1.serving.knative.dev/f1-upload-listing?method=POST #&returnStatusCode=true
  - name: process-event
    type: expression
    operation: |
      {
        transformed: (
          (
            .headers
            | to_entries
            | map(select(.key | ascii_downcase != "host"))
            | map({("HEADER_" + .key): .value})
            | add
          ) + .data
        )
      }

states:
  - name: entry-event
    type: event
    onEvents:
      - eventRefs:
          - triggerEvent
        actions:
        - functionRef: process-event
    stateDataFilter:
      output: "${ .transformed }"
    transition: entry-decision

  - name: entry-decision
    type: switch
    dataConditions:
      - condition: ${ ."postListing" == true }
        transition: f1-upload-listing
      - condition: ${ ."submitDoc" == true }
        transition: f2-upload-verification
      - condition: ${ ."submitClientInfo" == true }
        transition: f3-upload-client
    defaultCondition:
      end: true
  
  - name: f1-upload-listing
    type: operation
    actionMode: sequential # parallel
    actions: 
      - functionRef: f1
      - functionRef: f2
      - functionRef:
          refName: f5
    transition: d1
  
  - name: d1
    type: operation
    actions:
      - eventRef:
          triggerEventRef: uploadPhoto
          resultEventRef: newPhoto
    transition: f4-photo-verification

  
  - name: f4-photo-verification
    type: operation
    actions: 
      - functionRef: f4
    transition: f5-image-correction
  
  - name: f5-image-correction
    type: operation
    actions: 
      - functionRef: f5
    transition: f6-post-website
  
  - name: f6-post-website
    type: operation
    actions: 
      - functionRef: f6
    transition: advertise-listing
  
  - name: advertise-listing
    type: operation
    actions:
      - subFlowRef: advertise-listing
    end: true

  - name: f2-upload-verification
    type: operation
    actions:
      - functionRef: f2
    transition: d2

  - name: f3-upload-client
    type: operation
    actions:
      - functionRef: f3
    transition: d2

  - name: d2
    type: operation
    actions:
      - eventRef:
          triggerEventRef: uploadInfo
          resultEventRef: newInfo
    transition: new-info
  
  - name: new-info
    type: parallel
    branches:
      - name: post-website
        actions:
          - functionRef: f7
          - functionRef: f6
      - name: advertise
        actions:
          - subFlowRef: advertise-listing
    end: true
